---
title: 16：实现watch
date: 2024-03-04 
tags:
 - vue核心源码
categories:
 - vue核心源码
sidebar: 'auto'
---  
**watch基本使用方式**
1. 属性 ：方法(函数)
2. 属性 ：数组
3. 属性 ：对象
4. 属性 ：字符串
``` js
    watch: {
        'a'(newValue,oldValue){
            console.log(newValue,oldValue)
             },
        "a": [
              (newValue, oldValue) => {
                  console.log(newValue)
              },
              (newValue, oldValue) => {
                  console.log(newValue)
              }]
        a:{
             handler(){ //
                 console.log('xxx100')
             },
            immediate:true
             }
             // a:'aa'
            },
            methods:{
                aa(){}
            }
```
**initWatch**  
initState文件中,写入初始化watch的方法。首先遍历整个watch,针对不同的属性，watch调用createrWatcher方法来进行格式化处理，exprOrfn为表达式，表示可能是字符串/函数;options是用户配置的属性,比如deep、immediate。其中user属性为true时表示初次渲染。  
``` js
function initWatch(vm) {
    //1 获取watch
    let watch = vm.$options.watch
    console.log(watch)
    //2 遍历  { a,b,c}
    for (let key in watch) {
        //2.1获取 他的属性对应的值 （判断)
        let handler = watch[key] //数组 ，对象 ，字符，函数
        if (Array.isArray(handler)) {//数组  []
            hendler.forEach(item=>{
                createrWatcher(vm,key,item) 
            })
        } else {//对象 ，字符，函数
           //3创建一个方法来处理
           createrWatcher(vm,key,handler)
        }
    }
}
//vm.$watch(()=>{return 'a'}) // 返回的值就是  watcher 上的属性 user = false
//格式化处理
function createrWatcher(vm,exprOrfn,handler,options){
   //3.1 处理handler
   if(typeof handler ==='object'){
       options = handler; //用户的配置项目
       handler = handler.handler;//这个是一个函数
   }
   if(typeof handler ==='string'){// 'aa'
       handler = vm[handler] //将实例行的方法作为 handler 方法代理和data 一样
   }
   //其他是 函数
   //watch 最终处理 $watch 这个方法
   return vm.$watch(vm,exprOrfn,handler,options)
}
```