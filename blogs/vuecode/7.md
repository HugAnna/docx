---
title: 7：将虚拟dom变为真实dom
date: 2024-02-29
tags:
 - Vue核心源码
categories:
 - Vue核心源码
sidebar: 'auto'
---
> 上一节通过renderMixin获取到了虚拟节点,这一章将通过调用vm._updata方法将虚拟节点变为真实dom。  
### 1.首先将页面上的旧dom挂载到vm实例上  
![image.png](/vuecode/old-dom.png)  
### 2.调用lifecycleMixin  
在vm._update中获取vnode,并在patch方法中传入旧dom和虚拟dom
``` js
import {patch} from './vnode/patch'
export function lifecycleMixin(Vue){
  Vue.prototype._updata = function(vnode){ //vnode => 真实的dom
        // console.log(vnode)
        let vm = this
        // 需要区分是首次还是更新
        let prevVnode = vm._vnode
        if(!prevVnode){
        //两个参数 （1）旧dom (2)vnode
         vm.$el = patch(vm.$el,vnode);
         vm._vnode = vnode 
        }else {
         patch(prevVnode,vnode);
        }
       
  }
}
```
### 3.patch方法  
在patch方法中
1. 先通过递归调用createElement方法,将vnode变为真实dom。
2. 再通过js在父节点(body)中插入真实dom,并删除旧dom。
3. 返回真实dom，重新挂载到vm实例上
``` js
export function patch(oldVnode, vnode) {
    // console.log(oldVnode, vnode);
    //vnode =》真实 dom
    //（1） 创建新DOM
    let el = createEl(vnode)
    // console.log(el)
    //(2)替换  1）获取父节点  2）插入  3）删除
    let parentEL = oldVnode.parentNode // body
    parentEL.insertBefore(el,oldVnode.nextsibling)
    parentEL.removeChild(oldVnode)
    return el
}

//创建dom
function createEl(vnode) { //vnode: {tag,text,data,children}
    let { tag, children, key, data, text } = vnode
    if (typeof tag === 'string') { //标签
        vnode.el = document.createElement(tag) //创建元素 div
        //children []
        if (children.length > 0) { // [{}]
            children.forEach(child => {
                //递归
                vnode.el.appendChild(createEl(child))
            })
        }
    }else{
        vnode.el = document.createTextNode(text)
    }
    return vnode.el
}
```  
**vue面试题**
 vue的渲染流程： 数据初始化 => 对模块进行编译(解析成ast语法树) => 变成render函数 =>通过render函数变成vnode =>vnode变成真实dom => 渲染真实dom



