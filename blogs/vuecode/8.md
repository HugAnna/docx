---
title: 8：使用策略模式合并生命周期 
date: 2024-02-29
tags:
 - vue核心源码
categories:
 - vue核心源码
sidebar: 'auto'
---
### **1.订阅/收集Mixin注入的数据，方法等**    
**vue生命周期实现原理**  
1. Vue.Mixin({})混入,全局静态方法。
2. 通过订阅发布(设计模式)。Vue把生命周期进行订阅,然后在每个模块/实例中可以直接调用。
> vm实例中的配置项都会被放到options上,并添加到对应属性中方便调用。例options:{data:[]watch:[]}

在index.html中,调用vm上Mixin方法,并传入created 
![image.png](/vuecode/mixin.png)  

**入口文件**  
入口文件中,执行initGlobApi,初始化Vue全局api
```
import { initMixin } from "./init";
import {lifecycleMixin} from './lifecycle'
import { renderMixin} from './vnode/index'
import {initGlobApi} from './global-api/index'
function Vue(options){
     //初始化
     this._init(options)
}

  initMixin(Vue)
  lifecycleMixin(Vue) //添加生命周期
  renderMixin(Vue) //添加_render

  //全局方法  Vue.mixin Vue.component Vue.extend
  initGlobApi(Vue)
export default Vue
```  
**合并配置项**  
合并是为了收集Mixin注入的数据，方法。在Mixin方法中,将我们传入的相同配置项,合并到一个数组{created:[a,b],mounted:[c,d]}。  

```
import { mergeOptions } from "../utils/index.js";

export function initGlobApi(Vue) {
    // 源码 
    // Vue.options = {created:[a,b,c]}
    Vue.options = {} //定义options
    Vue.Mixin = function (mixin) { // {} {}
        // 对象的合并
        this.options = mergeOptions(this.options, mixin)
        console.log(Vue.options,999)
    }
}
```  
**mergeOptions**  
分别循环parent和child,进行合并处理  

```
export function mergeOptions(parent, child) { //parent:this.options child:mixin中传入的对象{ created:function a(){}}
    console.log(parent, child,11)
    // Vue.options = {created:[a,b]} //  Vue.mixin({created:f a()})
    const options = {}
    // parent为空,不执行
    for (let key in parent) {
        mergeField(key)
    }
    // 遍历对象中的配置项
    for (let key in child) { //{}
        mergeField(key)
    }
    function mergeField(key){
        //策略模式 根据不同的属性(key)   
        if(starts[key]){ //created {created:[a]}
             options[key] = starts[key](parent[key],child[key])
        }else{
            options[key] = child[key]
        }
    } 
    return options
}
```
**策略模式中不同策略**  
在starts中,根据不同的属性(key)/规则,采用策略模式,执行不同的逻辑。
```
 export const HOOKS = [
    "beforeCreate",
    "created",
    "beforeMount",
    "mounted",
    "beforeUpdate",
    "updated",
    "beforeDestory",
    "destroyed"
]
// 策略模式
let starts = {}
starts.data = function(parentVal,childVal){
   return childVal
} //合并data
starts.computed = function(){} //合并computed
starts.watch = function(){} //合并watch 
starts.methods = function(){} //合并methods 
//遍历生命周期
HOOKS.forEach(hooks=>{
    starts[hooks] = mergeHook
})
function mergeHook(parentVal,childVal){
   //{created:[a,b,c],watch:[a,b]}
   if(childVal){
       if(parentVal){
            return  parentVal.concat(childVal) //合并
       }else{
           return [childVal] // [a]
       }
   }else{
       return parentVal 
   }
}
```  
**mergeOptions完整代码**  
```
//对象合并  {created:[]}
 export  const HOOKS = [
    "beforeCreate",
    "created",
    "beforeMount",
    "mounted",
    "beforeUpdate",
    "updated",
    "beforeDestory",
    "destroyed"
]
// 策略模式
let starts = {}
starts.data = function(parentVal,childVal){
   return childVal
} //合并data
starts.computed = function(){} //合并computed
starts.watch = function(){} //合并watch 
starts.methods = function(){} //合并methods 
//遍历生命周期
HOOKS.forEach(hooks=>{
    starts[hooks] = mergeHook
})
function mergeHook(parentVal,childVal){
   //{created:[a,b,c],watch:[a,b]}
   if(childVal){
       if(parentVal){
            return  parentVal.concat(childVal)
       }else{
           return [childVal] // [a]
       }
   }else{
       return parentVal 
   }
}
export function mergeOptions(parent, child) { //{} child:就是mixin中的对象{ created:function a(){}}
    console.log(parent, child,11)
    // Vue.options = {created:[a,b]} //  Vue.mixin({created:f a()})
    const options = {}
    // parent为空不执行
    for (let key in parent) {
        mergeField(key)
    }
    for (let key in child) { //{}
        mergeField(key)
    }
    function mergeField(key){
        //根据key   策略模式
        if(starts[key]){ //created {created:[a]}
             options[key] = starts[key](parent[key],child[key])
        }else{
            options[key] = child[key]
        }
    } 
    return options
}
```  
### **2.订阅/合并vm实例中的数据，方法等**  
在index.html中传入我们的数据和方法  

![image.png](/vuecode/vm-merge.png)  

入口文件index.js中,通过initMixin方法,合并Mixin和vm中的option,放到$options上  

![image.png](/vuecode/vm-merge2.png)  
