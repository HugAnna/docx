---
title: 6：将render函数变为虚拟dom
date: 2024-02-20
tags:
 - Vue核心源码
categories:
 - Vue核心源码
sidebar: 'auto'
---
**初始化文件**  
在$mount方法中,通过调用compileToFunction方法,得到了ast语法树转成的render函数。并将render添加到了options选项上。

``` js
Vue.prototype.$mount = function (el) {
        console.log(el)
        // el template  render
        let vm = this
        el = document.querySelector(el) //获取元素
        vm.$el =  el 
        let options = vm.$options
        if (!options.render) { //没有
            let template = options.template
            if (!template && el) {
                //获取html
                el = el.outerHTML

                //<div id="app"> hello {{msg}}</div>
                // 获取render
               let render =  compileToFunction(el)
            //  console.log(render)
               
                options.render = render
            }
        }
        //挂载组件
        mounetComponent(vm,el) // 在$mount方法中,调用mounetComponent方法
    }

```
**入口文件**  
``` js
import { initMixin } from "./init";
import {lifecycleMixin} from './lifecycle'
import { renderMixin} from './vnode/index'

function Vue(options){
   
     //初始化
     this._init(options)
}

  initMixin(Vue)
  lifecycleMixin(Vue) //添加生命周期
  renderMixin(Vue) //添加_render

```
**主要代码**  
通过renderMixin方法,在vm上挂载_c(*解析标签*)、_v(*解析文本*)、_s(*解析变量*)方法。在vm._render中调用render()变成vnode并返回。  
``` js
 export function renderMixin(Vue){
    Vue.prototype._c = function(){ //标签
        //创建标签
        return createElement(...arguments)
    }
    Vue.prototype._v = function(text){ //文本
      return createText(text)
    }
    Vue.prototype._s = function(val){ //变量 _s(msg)
       return val ==null?"":(typeof val ==='object')?JSON.stringify(val):val
    }
   Vue.prototype._render = function(){ //render函数变成 vnode
     let vm = this
     let render = vm.$options.render
     let vnode  = render.call(this)
    //  console.log(vnode)
     return vnode
   }
 } 
//创建元素
function createElement(tag,data={},...children){
    return vnode(tag,data,data.key,children)
}
//创建文本
function createText(text){
    return vnode(undefined,undefined,undefined,undefined,text)
}
//创建vnode
function vnode(tag,data,key,children,text){
    return {
        tag,
        data,
        key,
        children,
        text
    }
}


```




